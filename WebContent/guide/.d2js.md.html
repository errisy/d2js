<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>C:\Users\Inshua\workspace\d2js\WebContent\guide\.d2js.md.html</title>


<style type="text/css">
body {
	color: #333;
	font: 13px/1.4 "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
	padding: 0;
	margin: 0;
}

a {
	background: transparent;
	color: #4183c4;
	text-decoration: none;
}

a:active,
a:hover {
	outline: 0 none;
	text-decoration: underline;
}

abbr[title] {
	border-bottom: 1px dotted;
}

b,
strong {
	font-weight: bold;
}

dfn {
	font-style: italic;
}
h1 {
	font-size: 2em;
	margin: 0.67em 0;
}
mark {
	background: #ff0;
	color: #000;
}
small {
	font-size: 80%;
}
sub, sup {
	font-size: 75%;
	line-height: 0;
	position: relative;
	vertical-align: baseline;
}
sup {
	top: -0.5em;
}
sub {
	bottom: -0.25em;
}
img {
	border: 0 none;
}
svg:not(:root) {
	overflow: hidden;
}
figure {
	margin: 1em 40px;
}
hr {
	box-sizing: content-box;
	height: 0;
}

code,
kbd,
pre,
samp {
	font-family: monospace,monospace;
	font-size: 1em;
}

pre {
	overflow: auto;
	font: 12px Consolas,"Liberation Mono",Menlo,Courier,monospace;
	margin-bottom: 0;
	margin-top: 0;
}

.markdown-body {
	padding: 30px;
	font-size: 16px;
	line-height: 1.6;
	word-wrap: break-word;
}

.markdown-body>*:first-child {
	margin-top: 0 !important;
}

.markdown-body>*:last-child {
	margin-bottom: 0 !important;
}

.markdown-body .absent {
	color: #c00;
}

.markdown-body .anchor {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	display: block;
	padding-right: 6px;
	padding-left: 30px;
	margin-left: -30px;
}

.markdown-body .anchor:focus {
	outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
	position: relative;
	margin-top: 1em;
	margin-bottom: 16px;
	font-weight: bold;
	line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
	display: none;
	color: #000;
	vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
	padding-left: 8px;
	margin-left: -30px;
	line-height: 1;
	text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
	display: inline-block;
}

.markdown-body h1 tt,
.markdown-body h1 code,
.markdown-body h2 tt,
.markdown-body h2 code,
.markdown-body h3 tt,
.markdown-body h3 code,
.markdown-body h4 tt,
.markdown-body h4 code,
.markdown-body h5 tt,
.markdown-body h5 code,
.markdown-body h6 tt,
.markdown-body h6 code {
	font-size: inherit;
}

.markdown-body h1 {
	padding-bottom: 0.3em;
	font-size: 2.25em;
	line-height: 1.2;
	border-bottom: 1px solid #eee;
}

.markdown-body h2 {
	padding-bottom: 0.3em;
	font-size: 1.75em;
	line-height: 1.225;
	border-bottom: 1px solid #eee;
}

.markdown-body h3 {
	font-size: 1.5em;
	line-height: 1.43;
}

.markdown-body h4 {
	font-size: 1.25em;
}

.markdown-body h5 {
	font-size: 1em;
}

.markdown-body h6 {
	font-size: 1em;
	color: #777;
}

.markdown-body p,.markdown-body blockquote,
.markdown-body ul,.markdown-body ol,
.markdown-body dl,.markdown-body table,
.markdown-body pre {
	margin-top: 0;
	margin-bottom: 16px;
}

.markdown-body hr {
	height: 4px;
	padding: 0;
	margin: 16px 0;
	background-color: #e7e7e7;
	border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
	padding-left: 2em;
}

.markdown-body ul.no-list,
.markdown-body ol.no-list {
	padding: 0;
	list-style-type: none;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
	margin-top: 0;
	margin-bottom: 0;
}

.markdown-body li>p {
	margin-top: 16px;
}

.markdown-body dl {
	padding: 0;
}

.markdown-body dl dt {
	padding: 0;
	margin-top: 16px;
	font-size: 1em;
	font-style: italic;
	font-weight: bold;
}

.markdown-body dl dd {
	padding: 0 16px;
	margin-bottom: 16px;
}

.markdown-body blockquote {
	padding: 0 15px;
	color: #777;
	border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
	margin-top: 0;
}

.markdown-body blockquote>:last-child {
	margin-bottom: 0;
}

.markdown-body table {
	display: block;
	width: 100%;
	overflow: auto;
	word-break: normal;
	word-break: keep-all;
}

.markdown-body table th {
	font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
	padding: 6px 13px;
	border: 1px solid #ddd;
}

.markdown-body table tr {
	background-color: #fff;
	border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
	background-color: #f8f8f8;
}

.markdown-body img {
	max-width: 100%;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}

.markdown-body span.frame {
	display: block;
	overflow: hidden;
}

.markdown-body span.frame>span {
	display: block;
	float: left;
	width: auto;
	padding: 7px;
	margin: 13px 0 0;
	overflow: hidden;
	border: 1px solid #ddd;
}

.markdown-body span.frame span img {
	display: block;
	float: left;
}

.markdown-body span.frame span span {
	display: block;
	padding: 5px 0 0;
	clear: both;
	color: #333;
}

.markdown-body span.align-center {
	display: block;
	overflow: hidden;
	clear: both;
}

.markdown-body span.align-center>span {
	display: block;
	margin: 13px auto 0;
	overflow: hidden;
	text-align: center;
}

.markdown-body span.align-center span img {
	margin: 0 auto;
	text-align: center;
}

.markdown-body span.align-right {
	display: block;
	overflow: hidden;
	clear: both;
}

.markdown-body span.align-right>span {
	display: block;
	margin: 13px 0 0;
	overflow: hidden;
	text-align: right;
}

.markdown-body span.align-right span img {
	margin: 0;
	text-align: right;
}

.markdown-body span.float-left {
	display: block;
	float: left;
	margin-right: 13px;
	overflow: hidden;
}

.markdown-body span.float-left span {
	margin: 13px 0 0;
}

.markdown-body span.float-right {
	display: block;
	float: right;
	margin-left: 13px;
	overflow: hidden;
}

.markdown-body span.float-right>span {
	display: block;
	margin: 13px auto 0;
	overflow: hidden;
	text-align: right;
}

.markdown-body code,.markdown-body tt {
	padding: 0;
	padding-top: 0.2em;
	padding-bottom: 0.2em;
	margin: 0;
	font-size: 85%;
	background-color: rgba(0,0,0,0.04);
	border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after,
.markdown-body tt:before,
.markdown-body tt:after {
	letter-spacing: -0.2em;
	content: "\00a0";
}

.markdown-body code br,
.markdown-body tt br {
	display: none;
}

.markdown-body del code {
	text-decoration: inherit;
}

.markdown-body pre>code {
	padding: 0;
	margin: 0;
	font-size: 100%;
	word-break: normal;
	white-space: pre;
	background: transparent;
	border: 0;
}

.markdown-body .highlight {
	margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
	padding: 16px;
	overflow: auto;
	font-size: 85%;
	line-height: 1.45;
	background-color: #f7f7f7;
	border-radius: 3px;
}

.markdown-body .highlight pre {
	margin-bottom: 0;
	word-break: normal;
}

.markdown-body pre {
	word-wrap: normal;
}

.markdown-body pre code,
.markdown-body pre tt {
	display: inline;
	max-width: initial;
	padding: 0;
	margin: 0;
	overflow: initial;
	line-height: inherit;
	word-wrap: normal;
	background-color: transparent;
	border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after,
.markdown-body pre tt:before,
.markdown-body pre tt:after {
	content: normal;
}

.highlight .pl-coc,
.highlight .pl-entl,
.highlight .pl-entm,
.highlight .pl-eoa,
.highlight .pl-mai .pl-sf,
.highlight .pl-mm,
.highlight .pl-pdv,
.highlight .pl-sc,
.highlight .pl-som,
.highlight .pl-sr,
.highlight .pl-v,
.highlight .pl-vpf {
	color: #0086b3;
}
.highlight .pl-eoac,
.highlight .pl-mdht,
.highlight .pl-mi1,
.highlight .pl-mri,
.highlight .pl-va,
.highlight .pl-vpu {
	color: #008080;
}
.highlight .pl-c,
.highlight .pl-pdc {
	color: #b4b7b4;
	font-style: italic;
}
.highlight .pl-k,
.highlight .pl-ko,
.highlight .pl-kolp,
.highlight .pl-mc,
.highlight .pl-mr,
.highlight .pl-ms,
.highlight .pl-s,
.highlight .pl-sok,
.highlight .pl-st {
	color: #6e5494;
}
.highlight .pl-ef,
.highlight .pl-enf,
.highlight .pl-enm,
.highlight .pl-entc,
.highlight .pl-eoi,
.highlight .pl-sf,
.highlight .pl-smc {
	color: #d12089;
}
.highlight .pl-ens,
.highlight .pl-eoai,
.highlight .pl-kos,
.highlight .pl-mh .pl-pdh,
.highlight .pl-mp,
.highlight .pl-pde,
.highlight .pl-stp {
	color: #458;
}
.highlight .pl-enti {
	color: #d12089;
	font-weight: bold;
}
.highlight .pl-cce,
.highlight .pl-enc,
.highlight .pl-kou,
.highlight .pl-mq {
	color: #f93;
}
.highlight .pl-mp1 .pl-sf {
	color: #458;
	font-weight: bold;
}
.highlight .pl-cos,
.highlight .pl-ent,
.highlight .pl-md,
.highlight .pl-mdhf,
.highlight .pl-ml,
.highlight .pl-pdc1,
.highlight .pl-pds,
.highlight .pl-s1,
.highlight .pl-scp,
.highlight .pl-sol {
	color: #df5000;
}
.highlight .pl-c1,
.highlight .pl-cn,
.highlight .pl-pse,
.highlight .pl-pse .pl-s2,
.highlight .pl-vi {
	color: #a31515;
}
.highlight .pl-mb,
.highlight .pl-pdb {
	color: #df5000;
	font-weight: bold;
}
.highlight .pl-mi,
.highlight .pl-pdi {
	color: #6e5494;
	font-style: italic;
}
.highlight .pl-ms1 {
	background-color: #f5f5f5;
}
.highlight .pl-mdh,
.highlight .pl-mdi {
	font-weight: bold;
}
.highlight .pl-mdr {
	color: #0086b3;
	font-weight: bold;
}
.highlight .pl-s2 {
	color: #333;
}
.highlight .pl-ii {
	background-color: #df5000;
	color: #fff;
}
.highlight .pl-ib {
	background-color: #f93;
}
.highlight .pl-id {
	background-color: #a31515;
	color: #fff;
}
.highlight .pl-iu {
	background-color: #b4b7b4;
}
.highlight .pl-mo {
	color: #969896;
}

</style>


<script type="text/javascript">

function getDocumentScrollTop() 
{
   var res = document.body.scrollTop || document.documentElement.scrollTop || window.pageYOffset || 0;
   // alert(res);
   return res;
}

function setDocumentScrollTop(ypos) 
{
	window.scrollTo(0, ypos);
}

</script>


</head>
<body class="markdown-body">
<h1> <a id="user-content-d2js" class="anchor" href="#d2js" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>d2js</h1> 
<h1></h1> 
<p>d2js 是一套js数据前后端框架, 前端和后端可单独使用.</p> 
<p>d2js 前端基于经典的 mvc 理念设计, mvc 的是用于划分界面和数据逻辑的思想。</p> 
<p><a href="images/mvc.jpg?raw=true" target="_blank"><img src="images/mvc.jpg?raw=true" alt="mvc模型" style="max-width:100%;" /></a></p> 
<ul> 
 <li>from: <a href="http://baike.sogou.com/v41960817.htm">http://baike.sogou.com/v41960817.htm</a> </li> 
</ul> 
<p>d2js 遵循 mvc 思想设计，主要设计思想为<code>数据-渲染-收集</code>，d2js 将数据绘制到 GUI的行为称为<em>渲染(render)</em>，将其中从 GUI 输入导致的 controller 行为称为从界面<em>收集(collect)</em>。</p> 
<p><a href="images/d2js-mvc.png?raw=true" target="_blank"><img src="images/d2js-mvc.png?raw=true" alt="d2js 的 gui 理念" style="max-width:100%;" /></a></p> 
<p>mvc 是一种设计思想，很多人错误的把思想当做了程序架构，从而走上 Model-Controller-Viewer 对象模型的歪路，这是对 mvc 思想的极大误解。</p> 
<h2> <a id="user-content-简单js对象的渲染直接渲染" class="anchor" href="#%E7%AE%80%E5%8D%95js%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%B8%B2%E6%9F%93%E7%9B%B4%E6%8E%A5%E6%B8%B2%E6%9F%93" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>简单js对象的渲染——直接渲染</h2> 
<p>创建一个名为 a.html的网页：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;!DOCTYPE html&gt;
&lt;<span class="pl-ent">html</span>&gt;
&lt;<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">meta</span> <span class="pl-e">charset</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>UTF-8<span class="pl-pds">&quot;</span></span>&gt;
&lt;<span class="pl-ent">title</span>&gt;d2js&lt;/<span class="pl-ent">title</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/jquery-1.10.2.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/date.js/Date.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;

&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/d2js/dataset.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/d2js/render.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/d2js/renderers.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/d2js/collector.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>../jslib/d2js/pipelines.js<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;/<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">body</span>&gt;

&lt;/<span class="pl-ent">body</span>&gt;

&lt;/<span class="pl-ent">html</span>&gt;</pre>
</div> 
<p>在 body 部分输入：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>na<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);      <span class="pl-c">// 将 person对象渲染到 #info 元素 </span></span>
<span class="pl-s1">    <span class="pl-c">// 或使用 jQuery 形式: $('#info').render(person, true)</span></span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>输入网址查看效果：</p> 
<p><a href="images/d2js-1.png?raw=true" target="_blank"><img src="images/d2js-1.png?raw=true" alt="d2js guide 1" style="max-width:100%;" /></a></p> 
<p>界面很朴素。d2js 是一个数据框架，依托于DOM，可以和各种流行的 css 框架结合。当页面披上 bootstrap, semantic-ui 等 css外衣后，何愁不美轮美奂。</p> 
<p>d2js 主要扩充了 <code>data</code>, <code>renderer</code>, <code>collector</code> 3个 html 属性，用于声明页面元素的渲染、收集行为。 渲染、收集过程采用声明式规则，对于不存在的对象属性，不发生渲染，对于存在的属性，调用 renderer 指定的函数序列进行渲染。 数据与 ui 都是 d2js.render 函数的参数，当调用 d2js.render 时，数据才与 ui 元素发生联系，d2js.render 调用完后，联系即消失。</p> 
<h3> <a id="user-content-渲染路径" class="anchor" href="#%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>渲染路径</h3> 
<p>所扩充html属性中，<code>data</code>为<code>渲染路径</code>，用于锚定数据。</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>fav,movies,0<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>, fav<span class="pl-k">:</span>{movies<span class="pl-k">:</span>[<span class="pl-s"><span class="pl-pds">'</span>earth<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>matrix<span class="pl-pds">'</span></span>], songs<span class="pl-k">:</span>[<span class="pl-s"><span class="pl-pds">'</span>lalala<span class="pl-pds">'</span></span>]};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><code>&lt;p *data=&quot;fav,movies,0&quot;* renderer=&quot;std&quot; /&gt;</code> 中，data 部分为多层次的数据路径。 很显然，每个 <code>,</code> 都带来一次层次推进。</p> 
<h3> <a id="user-content-渲染器" class="anchor" href="#%E6%B8%B2%E6%9F%93%E5%99%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>渲染器</h3> 
<p>渲染器是属于 <code>d2js.Renderers</code> 的成员函数，用于将锚定的数据值画到相应DOM元素。渲染器函数可以自行扩充。</p> 
<p>例如 <code>std</code> 函数，定义于 <code>renderers.js</code> 中： <code>d2js.Renderers.std = function(){...}</code></p> 
<p>渲染器函数被调用时收到的实参参数列表为 html element 及按数据路径展开过程中的所有分解出的数据。</p> 
<p>例如，当<code>d2js.render</code>作用于 <code>&lt;p data=&quot;name&quot; renderer=&quot;std&quot; /&gt;</code> 和 <code>person</code> 对象时，<code>std</code> 函数实参参数列表如下：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-k">&lt;</span>p<span class="pl-k">/</span><span class="pl-k">&gt;</span>, <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, person, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span></pre>
</div> 
<p>前 2 个实参固定为 <code>element</code> 和 <code>value</code>，后面的实参由数据路径的展开过程产生。</p> 
<p>当 <code>d2js.render</code>作用于<code>&lt;p data=&quot;fav,movies,0&quot; renderer=&quot;std&quot; /&gt;</code>时，<code>std</code> 函数将收到如下参数：</p> 
<pre><code>&lt;p/&gt;, 'earth', person, 'fav', person.fav, 'movies', person.fav.movies, 0, person.fav.movies[0] 即 'earth'
</code></pre> 
<p>自定义的渲染器可以根据该特性实现更灵活的渲染行为。</p> 
<h3> <a id="user-content-自定义渲染器" class="anchor" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E5%99%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>自定义渲染器</h3> 
<p>通过对 <code>d2js.Renderers</code>插拔成员函数，可以添加新的渲染器。 如：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>red<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-c1">d2js.Renderers</span>.<span class="pl-en">red</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">element</span>, <span class="pl-smi">value</span>){</span>
<span class="pl-s1">        <span class="pl-smi">element</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;font color=&quot;red&quot;&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span> value <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;/font&gt;<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>也可以在渲染时提供自定义的渲染函数，如</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>red<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>, </span>
<span class="pl-s1">        {<span class="pl-en">red</span> <span class="pl-k">:</span>  <span class="pl-k">function</span>(<span class="pl-smi">element</span>, <span class="pl-smi">value</span>){</span>
<span class="pl-s1">                <span class="pl-smi">element</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;font color=red&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span> value <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;/font&gt;<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">            }</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    );</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>或在网页中嵌入一个 d2js 自定义标记 <code>renderer</code>：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">renderer</span>&gt;element.innerHTML = '&lt;<span class="pl-ent">font</span> <span class="pl-e">color</span>=<span class="pl-s">red</span>&gt;' + value + '&lt;/<span class="pl-ent">font</span>&gt;'&lt;/<span class="pl-ent">renderer</span>&gt; 
    &lt;/<span class="pl-ent">p</span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><a href="images/d2js-2.png?raw=true" target="_blank"><img src="images/d2js-2.png?raw=true" alt="d2js guide 2" style="max-width:100%;" /></a></p> 
<h3> <a id="user-content-管道" class="anchor" href="#%E7%AE%A1%E9%81%93" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>管道</h3> 
<p>渲染器可以使用管道实现诸如译值之类的行为。</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>lastLogon<span class="pl-pds">&quot;</span></span> <span class="pl-e">format</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>MM-dd-yyyy<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>date|std<span class="pl-pds">&quot;</span></span> /&gt;<span class="pl-c">&lt;!-- date 是一个管道函数 --&gt;</span>
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>, lastLogon<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">Date</span>()};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><a href="images/d2js-3.png?raw=true" target="_blank"><img src="images/d2js-3.png?raw=true" alt="d2js guide 2" style="max-width:100%;" /></a></p> 
<p>这里，管道函数<code>date</code>将日期类型的<code>person.birth</code>翻译为一个指定格式的字符串，其中，<code>format</code> 是管道函数 date 所约定的自定义属性。</p> 
<p>管道函数接收的参数与渲染函数一样，只是它需要返回转换后的结果，且一般不应改变 element。</p> 
<p>管道函数可以串联拼接，例如，可以定义一个简单的管道函数</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js.Renderers.Pipelines</span>.<span class="pl-en">tomorrow</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">element</span>, <span class="pl-smi">value</span>){
    <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-en">Date</span>(value <span class="pl-k">*</span> <span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">86400000</span>);
}</pre>
</div> 
<p>使用 <code>tomorrow|date|std</code>可以先获取第二天的日期，再传入管道函数 date 转换为日期格式字符串。</p> 
<h2> <a id="user-content-简单js对象的收集" class="anchor" href="#%E7%AE%80%E5%8D%95js%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%94%B6%E9%9B%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>简单js对象的收集</h2> 
<p>渲染将数据画到界面上，反之，收集则是将界面上的内容采集到数据中。</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    Gender:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>/&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>input<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){</span>
<span class="pl-s1">        <span class="pl-smi">d2js</span>.<span class="pl-en">collect</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>person change to <span class="pl-pds">'</span></span>, person);</span>
<span class="pl-s1">    });</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><a href="images/d2js-collect.png?raw=true" target="_blank"><img src="images/d2js-collect.png?raw=true" alt="d2js guide collect" style="max-width:100%;" /></a></p> 
<p>收集器总是以管道组合形式出现。其中 <code>c</code> 是定义于 <code>collector.js</code>中的管道函数：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js.Collectors.Pipelines</span>.<span class="pl-en">c</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">element</span>, <span class="pl-smi">value</span>){
    <span class="pl-k">var</span> newValue <span class="pl-k">=</span> <span class="pl-c1">null</span>;
    <span class="pl-k">if</span>(<span class="pl-s"><span class="pl-pds">'</span>value<span class="pl-pds">'</span></span> <span class="pl-k">in</span> element){
        newValue <span class="pl-k">=</span> <span class="pl-smi">element</span>.<span class="pl-c1">value</span>;
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(<span class="pl-s"><span class="pl-pds">'</span>innerHTML<span class="pl-pds">'</span></span> <span class="pl-k">in</span> element){
        newValue <span class="pl-k">=</span> <span class="pl-smi">element</span>.<span class="pl-smi">innerHTML</span>;
    } <span class="pl-k">else</span> {
        <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>unsupported element type<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">element</span>.<span class="pl-c1">nodeName</span>);
    }
    <span class="pl-k">return</span> newValue;
}</pre>
</div> 
<p><code>s</code> 是定义于 <code>collector.js</code>中的收集器函数：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-smi">d2js</span>.<span class="pl-smi">Collectors</span>.<span class="pl-smi">s</span> <span class="pl-k">=</span> <span class="pl-smi">d2js</span>.<span class="pl-c1">KNOWN_COLLECTORS</span>[<span class="pl-s"><span class="pl-pds">'</span>s<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">element</span>, <span class="pl-smi">newValue</span>){
    <span class="pl-k">var</span> obj <span class="pl-k">=</span> arguments[<span class="pl-smi">arguments</span>.<span class="pl-c1">length</span> <span class="pl-k">-</span><span class="pl-c1">2</span>];
    <span class="pl-k">var</span> attr <span class="pl-k">=</span> arguments[<span class="pl-smi">arguments</span>.<span class="pl-c1">length</span> <span class="pl-k">-</span><span class="pl-c1">1</span>];
    <span class="pl-k">if</span>(newValue <span class="pl-k">===</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>) newValue <span class="pl-k">=</span> <span class="pl-c1">null</span>;
    <span class="pl-k">if</span>(obj <span class="pl-k">!=</span> <span class="pl-c1">null</span>){    <span class="pl-c">// dont test attr in obj</span>
        <span class="pl-k">if</span>(<span class="pl-smi">obj</span>.<span class="pl-smi">set</span>){
            <span class="pl-smi">obj</span>.<span class="pl-en">set</span>(attr, newValue);
        } <span class="pl-k">else</span> <span class="pl-k">if</span>(<span class="pl-smi">obj</span>.<span class="pl-smi">_set</span>){
            <span class="pl-smi">obj</span>.<span class="pl-en">_set</span>(attr, newValue);
        } <span class="pl-k">else</span> {
            obj[attr] <span class="pl-k">=</span> newValue;
        }
    }
}</pre>
</div> 
<p>可见，<code>c</code> 的作用是收集界面输入的数据，<code>s</code> 的作用是设置到数据路径所锚定的属性上。</p> 
<p>当数据需要加工时，可以串接其它管道函数：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    Gender:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>/&gt;
    Birth:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>birth<span class="pl-pds">&quot;</span></span> <span class="pl-e">format</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>yyyy-MM-dd<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>date|std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|d|s<span class="pl-pds">&quot;</span></span>/&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>, birth<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">Date</span>()};</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>input<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){</span>
<span class="pl-s1">        <span class="pl-smi">d2js</span>.<span class="pl-en">collect</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">true</span>); <span class="pl-c">// 或 $('#info').collect(person, true);</span></span>
<span class="pl-s1">        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>person change to <span class="pl-pds">'</span></span>, person);</span>
<span class="pl-s1">    });</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><code>c|d|s</code> 中，<code>d</code> 是将数据转为日期类型的函数（<code>c</code> 采集到的是字符串）。</p> 
<p>和很多其它框架不同，d2js 并不采用灵敏数据绑定的设计，不对控件侦听变动事件，只在调用 d2js.collect 时才执行收集过程。</p> 
<h3> <a id="user-content-自定义收集器" class="anchor" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%94%B6%E9%9B%86%E5%99%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>自定义收集器</h3> 
<p>类似渲染器，可以有两种方式自定义收集器：</p> 
<ol> 
 <li>对 d2js.Collectors 或 d2js.Collectors.Pipelines 插入函数</li> 
 <li>在调用 d2js.collect 函数时，提供第 4 个参数 customCollectors。</li> 
</ol> 
<h2> <a id="user-content-绝对数据路径" class="anchor" href="#%E7%BB%9D%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%B7%AF%E5%BE%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>绝对数据路径</h2> 
<p>数据路径支持 <code>#</code> 开始的绝对数据路径。如</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {d2js<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>person<span class="pl-pds">'</span></span>, name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-c">// 锚定 name='mary'的 person 对象</span></span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">false</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">var</span> person <span class="pl-k">=</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>jack<span class="pl-pds">'</span></span>, friend <span class="pl-k">:</span> {d2js<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>person<span class="pl-pds">'</span></span>, name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>girl<span class="pl-pds">'</span></span>}};</span>
<span class="pl-s1">    <span class="pl-c">// 自动下溯，依然锚定 name='mary'的 person 对象</span></span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>), person, <span class="pl-c1">false</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>后面将看到，绝对数据路径在 d2js 是运用更广泛的方式。</p> 
<h2> <a id="user-content-d2js-与-rdbms" class="anchor" href="#d2js-%E4%B8%8E-rdbms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>d2js 与 RDBMS</h2> 
<p>d2js 具有与关系型数据库同构的 <code>dataset-DataTable-DataColumn,DataRow</code> 体系(该设计思想来源于 ADO.net)， 可以与关系型数据库极好的配合。</p> 
<p><a href="images/d2js-dataset.png?raw=true" target="_blank"><img src="images/d2js-dataset.png?raw=true" alt="dataset" style="max-width:100%;" /></a></p> 
<h3> <a id="user-content-datatable-及其渲染" class="anchor" href="#datatable-%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DataTable 及其渲染</h3> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>persons<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
        &lt;<span class="pl-ent">p</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> /&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> table <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>person<span class="pl-pds">'</span></span>);  <span class="pl-c">// 定义一个表名为 person 的 DataTable 对象</span></span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-en">fill</span>([        <span class="pl-c">// 填充数据</span></span>
<span class="pl-s1">            {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>tom<span class="pl-pds">'</span></span>, gender <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>male<span class="pl-pds">'</span></span>},</span>
<span class="pl-s1">            {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>jack<span class="pl-pds">'</span></span>, gender <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>male<span class="pl-pds">'</span></span>},</span>
<span class="pl-s1">            {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>female<span class="pl-pds">'</span></span>}</span>
<span class="pl-s1">        ]);</span>
<span class="pl-s1">    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>columns<span class="pl-pds">'</span></span>, <span class="pl-smi">table</span>.<span class="pl-smi">columns</span>);</span>
<span class="pl-s1">    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>rows<span class="pl-pds">'</span></span>, <span class="pl-smi">table</span>.<span class="pl-c1">rows</span>);</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>), table);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><a href="images/d2js-datatable-1.png?raw=true" target="_blank"><img src="images/d2js-datatable-1.png?raw=true" alt="datatable 1" style="max-width:100%;" /></a></p> 
<p>DataTable 在创建时，总是加入到 <code>d2js.dataset</code> 对象。</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-k">var</span> table <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>person<span class="pl-pds">'</span></span>);
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">d2js</span>.<span class="pl-smi">dataset</span>.<span class="pl-smi">person</span> <span class="pl-k">==</span> table);      <span class="pl-c">// 输出 true</span></pre>
</div> 
<p>DataTable 在创建时，总是生成属性 <code>d2js : tableName</code>， 绝对数据路径支持自动下溯特性，因此：</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>), <span class="pl-smi">d2js</span>.<span class="pl-smi">dataset</span>);
    相当于：
    <span class="pl-k">for</span>(<span class="pl-k">var</span> tname <span class="pl-k">in</span> <span class="pl-smi">d2js</span>.<span class="pl-smi">dataset</span>){
        <span class="pl-k">if</span>(<span class="pl-smi">d2js</span>.<span class="pl-smi">dataset</span>[k].<span class="pl-smi">isDataTable</span>){
            <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>), <span class="pl-smi">d2js</span>.<span class="pl-smi">dataset</span>[k]);
        }
    }</pre>
</div> 
<p>在实际开发中，常常需要将 dataset 中的数据全部更新到界面，后面一种写法更有普遍性。因此，<code>d2js.dataset</code> 被设计为 d2js.render 的默认参数。</p> 
<p>故 <code>d2js.render($('#persons'), d2js.dataset);</code> 可进一步简化为：</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>), <span class="pl-c1">null</span>);
    或
    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>));</pre>
</div> 
<p>当需要更新网页所有元素时，可使用</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>(<span class="pl-c1">null</span>, <span class="pl-c1">null</span>);
    或
    <span class="pl-smi">d2js</span>.<span class="pl-en">render</span>();</pre>
</div> 
<p>综上，d2js 可以支持对 html element 局部渲染，也支持与 DataTable 相关的元素的局部渲染。</p> 
<h3> <a id="user-content-datatable-的收集" class="anchor" href="#datatable-%E7%9A%84%E6%94%B6%E9%9B%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DataTable 的收集</h3> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>persons<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span>&gt;
        Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
        Gender:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> table <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>person<span class="pl-pds">'</span></span>);  </span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-en">fill</span>([        <span class="pl-c">// 填充数据</span></span>
<span class="pl-s1">            {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>tom<span class="pl-pds">'</span></span>, gender <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>male<span class="pl-pds">'</span></span>},</span>
<span class="pl-s1">            {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>jack<span class="pl-pds">'</span></span>, gender <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>male<span class="pl-pds">'</span></span>},</span>
<span class="pl-s1">            {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>female<span class="pl-pds">'</span></span>}</span>
<span class="pl-s1">        ]);</span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>).<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>input<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){</span>
<span class="pl-s1">        <span class="pl-smi">d2js</span>.<span class="pl-en">collect</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1">        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(table);</span>
<span class="pl-s1">    });</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>注意观察当数据有变化时，<code>DataRow._state</code> 会变为 <code>'edit'</code> 状态。这个状态指示该行数据发生了编辑。</p> 
<h3> <a id="user-content-使用-datarow" class="anchor" href="#%E4%BD%BF%E7%94%A8-datarow" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>使用 DataRow</h3> 
<p>DataTable 中的数据行可以当做实体对象访问：</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-smi">table</span>.<span class="pl-c1">rows</span>.<span class="pl-en">forEach</span>(<span class="pl-k">function</span>(<span class="pl-smi">person</span>, <span class="pl-smi">index</span>){
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(index, <span class="pl-smi">person</span>.<span class="pl-c1">name</span>, <span class="pl-smi">person</span>.<span class="pl-smi">gender</span>);
    });
    <span class="pl-k">var</span> mary <span class="pl-k">=</span> <span class="pl-smi">table</span>.<span class="pl-c1">find</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>);
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-cce">\'</span>s gender: <span class="pl-pds">'</span></span>, <span class="pl-smi">mary</span>.<span class="pl-smi">gender</span>);</pre>
</div> 
<p>DataRow 总是属于 DataTable，DataTable 的每个 DataColumn，在DataRow都有列名对应的属性。</p> 
<p>DataRow 可以通过<code>DataTable.prototype.newRow()</code> 创建，通过 <code>DataTable.prototype.addRow</code> 添加到 <code>table.rows</code> 数组，此时 <code>_state</code> 为 <code>'new'</code>。</p> 
<p>通过 <code>_remove()</code> 方法可以删除 DataRow 对象，此时该对象还放在 <code>DataTable.rows</code> 中，只是 <code>_state</code> 为 <code>'remove'</code>。</p> 
<p>通过<code>_set(columnName, value)</code> 可以修改字段值，如值确实有变化，会导致 <code>_state</code> 变为 <code>'edit'</code>。使用 <code>row[colName] = new value</code> 则不会引发 <code>_state</code> 变化，所以大部分情况应使用 <code>_set</code>, 该函数为 continous 函数，可连续使用：<code>row._set('name','Jack')._set('age', 18)</code>，批量赋值也可以使用 <code>_setValues</code> 函数。常用的收集器 <code>s</code> 对 DataRow 类型的对象默认调用的就是 <code>_set</code> 方法。</p> 
<p>DataRow 像普通的 js 对象一样，可以插拔自己的属性，也可以修改 DataRow.prototype 使所有 DataRow 实例获得新的属性方法。</p> 
<p>数据库设计中字段名应尽量避免与 DataRow 的固有属性方法重名，DataRow 固有的属性方法总是以 <code>_</code> 开始，只要字段名不以 <code>_</code> 开始就不会发生冲突。</p> 
<h3> <a id="user-content-datatable-与-rdbms" class="anchor" href="#datatable-%E4%B8%8E-rdbms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DataTable 与 RDBMS</h3> 
<p>d2js 框架不仅仅具有前端功能，也支持服务器端功能。</p> 
<p>目前，d2js 后端可部署于 jdk8 以上的 servlet3.0 容器，使用 jdbc 数据库连接 ，可较好的支持 oracle, postgresql 等数据库。</p> 
<p>本示例中使用的是 <code>bookstore</code> 数据库，请见<a href="..\.readme.md.html">初始化环境一章</a>。 TODO</p> 
<p>下面编写一个名为 <code>author.d2js</code> 文件，放在前述网页的同一文件夹。</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(<span class="pl-s"><span class="pl-pds">'</span>select * from author order by name<span class="pl-pds">'</span></span>);
}</pre>
</div> 
<p>前端可由该<code>author.d2js</code> 的 <code>fetch</code> 函数获取数据：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>persons<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span>&gt;
        Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
        Gender:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> table <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>author.d2js<span class="pl-pds">'</span></span>);  </span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){</span>
<span class="pl-s1">        <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>(table);</span>
<span class="pl-s1">    });</span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>).<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>input<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){</span>
<span class="pl-s1">        <span class="pl-smi">d2js</span>.<span class="pl-en">collect</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1">    });</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>这样，通过 <code>table.load('fetch')</code>，数据库中的数据就被提取到了前端。</p> 
<p>显然，<code>load</code> 函数使用的是 ajax 方式提取的。可见，每个d2js都是一个可以通过ajax访问的服务。这种服务可以通过浏览器直接输入网址的形式观察到：</p> 
<p>在浏览器地址栏输入：</p> 
<pre><code>http://&lt;&lt;your website&gt;&gt;/author.d2js?_m=fetch
</code></pre> 
<p><a href="images/d2js-output.png?raw=true" target="_blank"><img src="images/d2js-output.png?raw=true" alt="d2js output" style="max-width:100%;" /></a></p> 
<p>可以看到，该接口实际上返回了一个json格式的查询结果，由此不难推断 load 函数的运作原理。</p> 
<h3> <a id="user-content-参数化查询及-sql--块" class="anchor" href="#%E5%8F%82%E6%95%B0%E5%8C%96%E6%9F%A5%E8%AF%A2%E5%8F%8A-sql--%E5%9D%97" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>参数化查询及 sql{. .} 块</h3> 
<p>d2js 接口可以支持两种形式输入参数。 0. 简单输入</p> 
<pre><code>http://.../author.d2js?_m=fetch&amp;name=mary
</code></pre> 
<ol> 
 <li> <p>参数打包为JSON输入</p> <p>http://.../author.d2js?_m=fetch&amp;params={&quot;name&quot;:&quot;mary&quot;}</p> </li> 
</ol> 
<p>由于json可以传递若干常见数据类型，因此当使用 d2js 前端时，自动采用后面的做法。</p> 
<p>接口可以接收传入的查询参数： <code>author.d2js</code></p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(<span class="pl-s"><span class="pl-pds">'</span>select * from author where name= ? order by name<span class="pl-pds">'</span></span>, [<span class="pl-smi">params</span>.<span class="pl-c1">name</span>]);
}</pre>
</div> 
<p>或</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(<span class="pl-s"><span class="pl-pds">'</span>select * from author where name= :name order by name<span class="pl-pds">'</span></span>, params);
}</pre>
</div> 
<p>关于 <code>query</code>函数及 d2js 对象的其它函数，可详见 <code>WEB-INF/jslib/d2js/base.js</code>。</p> 
<p>输入前述网址可测试效果。</p> 
<p>如欲实现模糊查询，可将sql语句改为</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(<span class="pl-s"><span class="pl-pds">'</span>select * from author where strpos(name,:name) &gt; 0 order by name<span class="pl-pds">'</span></span>, params);
}</pre>
</div> 
<p>下面的代码实现了检查是否需要匹配 <code>name</code> 条件：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    <span class="pl-k">var</span> sql <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>select * from author where 1=1<span class="pl-pds">'</span></span>
    <span class="pl-k">if</span>(<span class="pl-smi">params</span>.<span class="pl-c1">name</span>){
        sql <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">'</span> and strpos(name,:name) &gt; 0<span class="pl-pds">'</span></span>;
    }
    sql <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">'</span>order by name<span class="pl-pds">'</span></span>;
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(sql, params);
}</pre>
</div> 
<p><code>d2js.query</code>和<code>d2js.execute</code>等函数并不是简单的拼接sql字符串，而是使用 <code>PrepareStatement</code>实现的真正的参数化查询，因此无需顾虑SQL注入。</p> 
<p>在 d2js 中，还有一种更直观的书写形式：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    sql{.
        select <span class="pl-k">*</span> <span class="pl-k">from</span> author where <span class="pl-c1">1</span><span class="pl-k">=</span><span class="pl-c1">1</span>
        code{.
            <span class="pl-k">if</span>(<span class="pl-smi">params</span>.<span class="pl-c1">name</span>){
                sql{.   <span class="pl-smi">and</span> <span class="pl-en">strpos</span>(name,<span class="pl-k">:</span>name) <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>  .}
            }
        .}
        order by name
    .}
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(sql, params);
}</pre>
</div> 
<p>或写作</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">fetch</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">params</span>){
    sql{.
        select <span class="pl-k">*</span> <span class="pl-k">from</span> author where <span class="pl-c1">1</span><span class="pl-k">=</span><span class="pl-c1">1</span>
        sql{.<span class="pl-k">?</span>(<span class="pl-smi">params</span>.<span class="pl-c1">name</span>)
            and <span class="pl-en">strpos</span>(name,<span class="pl-k">:</span>name) <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>
        .}
        order by name
    .}
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(sql, params);
}</pre>
</div> 
<p>当SQL语句较为复杂时，使用SQL块可以给开发带来极大的便利。通常只需将SQL语句从可视化SQL编辑器粘贴到d2js文件，将若干参数变为 <code>:arg</code> 的形式，即可完成一个接口的编写。需要对SQL修改时，也只需将d2js中的代码粘贴到SQL编辑器，修改完后再粘贴回来即可。</p> 
<p>在前端，可使用下面的编程方法注入查询参数。</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>ma<span class="pl-pds">'</span></span>});</pre>
</div> 
<p>也可由用户在网页输入，此时可设置输入参数的控件的数据路径为 <code>table,search,params,arg</code>，并设置相应的收集器：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>arguments<span class="pl-pds">&quot;</span></span>&gt;
    <span class="pl-c">&lt;!-- 用户在该控件输入要查询的人名 --&gt;</span>
    Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,search,params,name<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">button</span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>search()<span class="pl-pds">&quot;</span></span>&gt;Search&lt;/<span class="pl-ent">button</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
&lt;<span class="pl-ent">hr</span>&gt;
&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>persons<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span>&gt;
        Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
        Gender:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> table <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>author.d2js<span class="pl-pds">'</span></span>, {silent<span class="pl-k">:</span><span class="pl-c1">false</span>});    <span class="pl-c">// 指定 silent=false选项，在数据 load 时自动触发 d2js.render(null, table) </span></span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    <span class="pl-k">function</span> <span class="pl-en">search</span>(){</span>
<span class="pl-s1">        <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#arguments<span class="pl-pds">'</span></span>).<span class="pl-en">collect</span>();</span>
<span class="pl-s1">        <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p><a href="images/d2js-search.png?raw=true" target="_blank"><img src="images/d2js-search.png?raw=true" alt="d2js search" style="max-width:100%;" /></a></p> 
<h3> <a id="user-content-提交变动" class="anchor" href="#%E6%8F%90%E4%BA%A4%E5%8F%98%E5%8A%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>提交变动</h3> 
<p>用户在前端页面进行的数据修改，经收集后，可以通过 <code>table.submit()</code> 一次性提交到服务器。</p> 
<p>在d2js观念中，数据变动的粒度是行级的，变动类型有3种，编辑、新增、删除。为此，d2js文件需要编写三个接口函数：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">create</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">rcd</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-c1">insertRow</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, rcd, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>gender<span class="pl-pds">'</span></span>]);
}

<span class="pl-c1">d2js</span>.<span class="pl-en">modify</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">rcd</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">updateRow</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, rcd, [<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>gender<span class="pl-pds">'</span></span>]);
}

<span class="pl-c1">d2js</span>.<span class="pl-en">destroy</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">rcd</span>){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-c1">deleteRow</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, rcd);
}</pre>
</div> 
<p><code>create</code>对应<code>_state</code> 为 <code>new</code>状态的 DataRow，<code>modify</code>对应<code>edit</code>状态的 DataRow，<code>destroy</code>对应<code>remove</code>状态的 DataRow。</p> 
<p>在前端只需调用 <code>table.submit()</code>，服务器 <code>.d2js</code> 接口中的与行状态对应的函数将自动触发。该逻辑实现于 <code>base.js</code>中的<code>D2JS.prototype.update</code>函数。</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>arguments<span class="pl-pds">&quot;</span></span>&gt;
    <span class="pl-c">&lt;!-- 用户在该控件输入要查询的人名 --&gt;</span>
    &lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,search,params,name<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">button</span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>search()<span class="pl-pds">&quot;</span></span>&gt;Search&lt;/<span class="pl-ent">button</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
&lt;<span class="pl-ent">hr</span>&gt;
&lt;<span class="pl-ent">section</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>persons<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span>&gt;
        Name:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
        Gender:&lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
&lt;<span class="pl-ent">section</span>&gt;
    &lt;<span class="pl-ent">button</span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>table.submit()<span class="pl-pds">&quot;</span></span>&gt;Submit&lt;/<span class="pl-ent">button</span>&gt;
&lt;/<span class="pl-ent">section</span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-k">var</span> table <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>author.d2js<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>load<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>(<span class="pl-v">this</span>)};</span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-smi">table</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>submit<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">error</span>){ <span class="pl-c">// 提交成功后再次加载数据</span></span>
<span class="pl-s1">        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>submit done<span class="pl-pds">'</span></span>, error);</span>
<span class="pl-s1">        <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    });</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>).<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>input<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){</span>
<span class="pl-s1">        <span class="pl-smi">d2js</span>.<span class="pl-en">collect</span>(<span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#persons<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1">    });</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">function</span> <span class="pl-en">search</span>(){</span>
<span class="pl-s1">        <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#arguments<span class="pl-pds">'</span></span>).<span class="pl-en">collect</span>();</span>
<span class="pl-s1">        <span class="pl-smi">table</span>.<span class="pl-c1">load</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1"><span class="pl-k">&lt;</span><span class="pl-k">/</span>script<span class="pl-k">&gt;</span></span></pre>
</div> 
<h2> <a id="user-content-高级话题" class="anchor" href="#%E9%AB%98%E7%BA%A7%E8%AF%9D%E9%A2%98" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>高级话题</h2> 
<h3> <a id="user-content-调试渲染器和收集器" class="anchor" href="#%E8%B0%83%E8%AF%95%E6%B8%B2%E6%9F%93%E5%99%A8%E5%92%8C%E6%94%B6%E9%9B%86%E5%99%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>调试渲染器和收集器</h3> 
<p>为了查明渲染器的行为，可以在 <code>&lt;tag data=&quot;&quot; renderer=&quot;&quot;&gt;</code> 增加 <code>trace-render</code>，即</p> 
<pre><code>&lt;tag data=&quot;&quot; renderer=&quot;&quot; trace-render&gt;
</code></pre> 
<p>这样当渲染该元素时，会自动进入断点。</p> 
<p>同样，启用 <code>trace-collect</code> 可以追踪收集器的行为。</p> 
<h3> <a id="user-content-禁用收集器" class="anchor" href="#%E7%A6%81%E7%94%A8%E6%94%B6%E9%9B%86%E5%99%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>禁用收集器</h3> 
<p>有时有的元素虽然指定了数据路径和收集器，但是暂时不需要收集，此时可指定 'no-collect' 为 true，该属性对子元素有屏蔽作用——除非对子元素收集。</p> 
<h3> <a id="user-content-d2js-中的词典" class="anchor" href="#d2js-%E4%B8%AD%E7%9A%84%E8%AF%8D%E5%85%B8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>d2js 中的词典</h3> 
<p>在实际业务中，经常遇到枚举性质的词典，例如 <code>M=男 F=女</code>，数据库中存储的值为M,F，需要显示出来的是&quot;男，女&quot;。d2js 可以方便的处理词典。</p> 
<p>对于一次性的词典，在渲染器直接指定即可。如</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">p</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>dict({M:'男', F:'女'})|std<span class="pl-pds">&quot;</span></span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>({name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>}, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>对于多次使用的词典，可以创建为 <code>d2js.dataset.dicts</code> 的成员，如：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">input</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">dict</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>dict|std<span class="pl-pds">&quot;</span></span>&gt;
<span class="pl-s1">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">    <span class="pl-smi">d2js</span>.<span class="pl-smi">dataset</span>.<span class="pl-smi">dicts</span>.<span class="pl-smi">gender</span> <span class="pl-k">=</span> {M <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>男<span class="pl-pds">'</span></span>, F<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>女<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1">    <span class="pl-c">// 或简写为 </span></span>
<span class="pl-s1">    <span class="pl-smi">Dicts</span>.<span class="pl-smi">gender</span> <span class="pl-k">=</span> {M <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>男<span class="pl-pds">'</span></span>, F<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>女<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>({name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>}, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">&lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>此外，d2js 也支持数组性的词典，详见 d2js 手册。</p> 
<h3> <a id="user-content-渲染下拉列表框-" class="anchor" href="#%E6%B8%B2%E6%9F%93%E4%B8%8B%E6%8B%89%E5%88%97%E8%A1%A8%E6%A1%86-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>渲染下拉列表框 </h3> 
<p>下拉列表框实际上有两种类型的数据来源，一种是词典，一种是数据表。</p> 
<p>对于词典性数据，如前述<code>性别</code>词典，期望得到</p> 
<div class="highlight highlight-text-html-basic">
 <pre>    &lt;<span class="pl-ent">select</span>&gt;
        &lt;<span class="pl-ent">option</span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>M<span class="pl-pds">&quot;</span></span>&gt;男&lt;/<span class="pl-ent">option</span>&gt;
        &lt;<span class="pl-ent">option</span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>F<span class="pl-pds">&quot;</span></span>&gt;女&lt;/<span class="pl-ent">option</span>&gt;
    &lt;/<span class="pl-ent">select</span>&gt;</pre>
</div> 
<p>由于 select 本身是一种单值输入控件，具有输入控件固有的数据路径，故不能对 select 使用 <em>data=&quot;词典&quot; renderer=&quot;下拉列表&quot;</em> 这样的表述。 对下拉列表提供数据，需要在外层嵌套一层 div 或其它元素。如前述<code>性别</code>词典，可以表述为：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>    &lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#dicts<span class="pl-pds">&quot;</span></span> <span class="pl-e">dict</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>dictToList|options<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">select</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">select</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
<span class="pl-s1">    &lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">        <span class="pl-smi">Dicts</span>.<span class="pl-smi">gender</span> <span class="pl-k">=</span> {M <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>男<span class="pl-pds">'</span></span>, F<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>女<span class="pl-pds">'</span></span>};</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>({name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>}, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">    &lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>以 DataTable 为数据来源的下拉列表框，可以表述为:</p> 
<div class="highlight highlight-text-html-basic">
 <pre>    &lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#gender,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>options('value', 'mean')<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">select</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">select</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
<span class="pl-s1">    &lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">        <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>gender<span class="pl-pds">'</span></span>).<span class="pl-en">fill</span>([{value<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>M<span class="pl-pds">'</span></span>, mean<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>男<span class="pl-pds">'</span></span>}, {value<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>, mean<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>女<span class="pl-pds">'</span></span>}]);</span>
<span class="pl-s1">        <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>();</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#info<span class="pl-pds">'</span></span>).<span class="pl-en">render</span>({name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mary<span class="pl-pds">'</span></span>, gender<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>}, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">    &lt;/<span class="pl-ent">script</span>&gt;</span></pre>
</div> 
<p>其中 <code>renderer=&quot;options('value', 'mean')&quot;</code>，当值字段为 id，含义字段为 name 时，可以缩写为 </p> 
<pre><code>renderer=&quot;options&quot;
</code></pre> 
<h3> <a id="user-content-表达式渲染器-expr" class="anchor" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B8%B2%E6%9F%93%E5%99%A8-expr" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>表达式渲染器 expr</h3> 
<p>可以使用表达式渲染器渲染一些简单的内容，如：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,rows,0<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>expr<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>header<span class="pl-pds">&quot;</span></span>&gt;{{name}}&lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;</pre>
</div> 
<p>表达式渲染器书写更美观的，但是由于大量替换 innerHTML，效率较 std 渲染器低。</p> 
<h3> <a id="user-content-重复项渲染器-repeater" class="anchor" href="#%E9%87%8D%E5%A4%8D%E9%A1%B9%E6%B8%B2%E6%9F%93%E5%99%A8-repeater" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>重复项渲染器 repeater</h3> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>header<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater-empty</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true&gt;</span>
<span class="pl-s">        没有符合条件的查询结果</span>
<span class="pl-s">    &lt;/div&gt;</span>
<span class="pl-s">&lt;/div&gt;</span></pre>
</div> 
<p>repeater渲染器对所提供的数组类型的数据进行循环，将 <code>repeater=&quot;true&quot;</code> 的子元素视为模板，不断重复。 重复得到的克隆体元素，其具有 repeater-copy=&quot;true&quot;属性，并获得 jQuery 的 repeater-obj 数据，即可以通过 $('[repeater-copy]).data('repeater-obj')访问相应的实际数据。如本例中，即可访问 DataRow 对象。 当数组为空时，子元素中 <code>repeater-empty=&quot;true&quot;</code> 的子元素会被展示出来。</p> 
<p>模板子元素，也即<code>repeater=&quot;true&quot;</code>的元素，可以存在多个，并使用 when 表达式决定是否应当对本条数据展示，如：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span> <span class="pl-e">when</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender='F'<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>girl header<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;
        &lt;<span class="pl-ent">div</span>&gt;女性促销信息&lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span> <span class="pl-e">when</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>gender='M'<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>boy header<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater-empty</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true&gt;</span>
<span class="pl-s">        没有符合条件的查询结果</span>
<span class="pl-s">    &lt;/div&gt;</span>
<span class="pl-s">&lt;/div&gt;</span></pre>
</div> 
<p>重复项渲染器中，可以使用 expr 渲染器。此时，expr 元素的数据路径可指定为 <code>this</code>：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#person,rows<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>repeater<span class="pl-pds">&quot;</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>this<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>expr<span class="pl-pds">&quot;</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>header<span class="pl-pds">&quot;</span></span>&gt;{{name}}&lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">repeater-empty</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>true&gt;</span>
<span class="pl-s">        没有符合条件的查询结果</span>
<span class="pl-s">    &lt;/div&gt;</span>
<span class="pl-s">&lt;/div&gt;</span></pre>
</div> 
<h3> <a id="user-content-表格渲染器页码渲染器及可以编辑单行的对话框" class="anchor" href="#%E8%A1%A8%E6%A0%BC%E6%B8%B2%E6%9F%93%E5%99%A8%E9%A1%B5%E7%A0%81%E6%B8%B2%E6%9F%93%E5%99%A8%E5%8F%8A%E5%8F%AF%E4%BB%A5%E7%BC%96%E8%BE%91%E5%8D%95%E8%A1%8C%E7%9A%84%E5%AF%B9%E8%AF%9D%E6%A1%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>表格渲染器，页码渲染器及可以编辑单行的对话框</h3> 
<p>请见所提供的 <code>d2js-test/4.html</code> 的示例及其源码。</p> 
<h3> <a id="user-content-d2js-中使用事务" class="anchor" href="#d2js-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>d2js 中使用事务</h3> 
<p>d2js 中可以使用方便的使用数据库的事务。</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">test</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(){
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">doTransaction</span>(<span class="pl-k">function</span>(){
        <span class="pl-v">this</span>.<span class="pl-en">execute</span>(<span class="pl-s"><span class="pl-pds">'</span>update staff set salary = salary * 1.1<span class="pl-pds">'</span></span>);
        <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">query</span>(<span class="pl-s"><span class="pl-pds">'</span>select * from staff where id = ?<span class="pl-pds">'</span></span>, [<span class="pl-c1">12</span>]);
    })
}</pre>
</div> 
<h3> <a id="user-content-d2js-日志输出" class="anchor" href="#d2js-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>d2js 日志输出</h3> 
<p>d2js 现在使用 log4j 框架，每个引擎初始化即带有一个 <code>logger</code> 全局对象，可以使用 <code>logger.info, logger.debug, logger.error</code> 等日志函数，用法与 log4j 一样。</p> 
<p>可以在日志中使用 <code>JSON.strigify(js object)</code> 输出 js 对象，包括数据库查询结果、接收到的参数等等。</p> 
<p>可以在日志中使用 <code>logger.error('&lt;&lt;description&gt;&gt;', wrapJsError(e))</code> 打印错误堆栈日志。</p> 
<p>完善的错误处理得益于 jdk8 以上版本所提供的 narshorn js 引擎。</p> 
<h3> <a id="user-content-d2js-编写伪存储过程" class="anchor" href="#d2js-%E7%BC%96%E5%86%99%E4%BC%AA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>d2js 编写伪存储过程</h3> 
<p>事实上，如果不担心性能，d2js 可以部分取代存储过程，充当 js 语言编写的存储过程。</p> 
<p>d2js 提供 query, queryRow, querScalar, travel 等便捷的函数获取数据，提供 insertRow, updateRow, deleteRow, mergeRow 等函数更新数据库，并支持事务、IN-OUT游标、JSON,JSONB,ARRAY等等各种数据库语言自己都难以驾驭的数据类型，同时，d2js 还可以使用 request,session,response等web服务器对象，所以将d2js视为一种存储过程编写机制也不失为一种有趣的尝试。</p> 
<p>当然，由于d2js不运行于数据库服务器，每次执行SQL都将产生网络开销，所以效率不能与真正的存储过程相提并论。</p> 
<p>但是在不考虑运行效率的场合，使用 d2js 的存储过程也有较大的优势：</p> 
<ul> 
 <li>动态语言不需要 orm 就可以取用存储在数据库中的业务对象，对商业逻辑的表达能力更强</li> 
 <li>d2js 所依赖的 nashorn 引擎可以提供错误的堆栈信息，大部分数据库都没有错误堆栈</li> 
 <li>日志与服务器日志合在一处，便于排查错误</li> 
 <li>可以使用 js 的全部语法特性，并能通过 nashorn 引擎使用 java 语言的各种设施</li> 
 <li>d2js 中可以方便的从 session 等服务器端对象获取所需信息</li> 
 <li>服务器可以联合使用其它的 nosql 数据库</li> 
 <li>在实际开发中，d2js 灵活的注入或构造查询结果数据，在数据库没有就绪时可以先构造假数据</li> 
</ul> 
<h3> <a id="user-content-服务器端数据校验" class="anchor" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>服务器端数据校验</h3> 
<p>d2js 可以编写服务器校验逻辑，对输入的数据进行校验。如：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">create</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">rcd</span>){
    <span class="pl-en">$V</span>(rcd, {
        name <span class="pl-k">:</span> [<span class="pl-smi">V</span>.<span class="pl-smi">notNull</span>, <span class="pl-smi">V</span>.<span class="pl-en">shortest</span>(<span class="pl-c1">5</span>)],
        gender <span class="pl-k">:</span> [<span class="pl-smi">V</span>.<span class="pl-en">inside</span>([<span class="pl-s"><span class="pl-pds">'</span>M<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>])]
    });

    <span class="pl-v">this</span>.<span class="pl-c1">insertRow</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, rcd, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>gender<span class="pl-pds">'</span></span>]);
}</pre>
</div> 
<p>校验函数定义在 <code>WEB-INF/jslib/d2js/validation.js</code> 中。</p> 
<p>当校验失败时，前端对应的数据行 row._error_at[colName] 将出现值，可以使用渲染器 <code>flderr</code> 将其绘出。可参考 <code>d2js-test/4.html</code>，该页面用到了 bootstrap.js 样式。</p> 
<p>其中渲染字段错误的代码如：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>  &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>form-group<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,curr,_error_at,name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>flderr<span class="pl-pds">&quot;</span></span> <span class="pl-e">trace</span>&gt;
    &lt;<span class="pl-ent">label</span>&gt;Name&lt;/<span class="pl-ent">label</span>&gt;
    &lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>text<span class="pl-pds">&quot;</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>form-control<span class="pl-pds">&quot;</span></span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,curr,name<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|s<span class="pl-pds">&quot;</span></span>&gt;
  &lt;/<span class="pl-ent">div</span>&gt;</pre>
</div> 
<p><a href="images/d2js-validation.png?raw=true" target="_blank"><img src="images/d2js-validation.png?raw=true" alt="d2js validation" style="max-width:100%;" /></a></p> 
<p>其中，<code>curr</code> 属性为当前行，是该页面对 table 插拔的一个自定义属性，不是 dataset 标准属性。</p> 
<p>在后台 <code>.d2js</code> 文件中，也可以简单的引发其它错误：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">modify</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">rcd</span>){
    <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>permission denied<span class="pl-pds">'</span></span>);
}</pre>
</div> 
<p>使用下面 html 可以进行捕获：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>&lt;<span class="pl-ent">div</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>#author,curr,_error<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>stderr<span class="pl-pds">&quot;</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;</pre>
</div> 
<p><a href="images/d2js-validation2.png?raw=true" target="_blank"><img src="images/d2js-validation2.png?raw=true" alt="d2js validation" style="max-width:100%;" /></a></p> 
<p>可见，d2js 中的渲染是涵摄很广的概念。DataTable,DataRow 的错误、分页、状态都可以通过渲染来表达。</p> 
<h3> <a id="user-content-json-字段的显示与收集" class="anchor" href="#json-%E5%AD%97%E6%AE%B5%E7%9A%84%E6%98%BE%E7%A4%BA%E4%B8%8E%E6%94%B6%E9%9B%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>json 字段的显示与收集</h3> 
<p>postgresql9.3 以后的版本都提供 json 数据类型，pg9.4以上支持 jsonb 数据类型（d2js 默认使用 jsonb 数据类型）。使用 d2js 可以尽情发挥json类型的优势。</p> 
<p>示例数据表 author 有字段名为 info 的 jsonb 字段，用来存储其它字段列表中描述不周的信息。现假如需要将 linkin 账号放在 info 字段。</p> 
<p>json 字段的值到网页前端即自动变成 js 对象。如上述 author 表的 info 字段为 jsonb 类型，可以使用 row.info.linkin 访问其 linkin 属性。</p> 
<p>在界面渲染时，只要在数据路径使用</p> 
<pre><code>info,linkin
</code></pre> 
<p>即可显示该字段。</p> 
<p>对于 json 中的属性，收集器不能再使用 <code>s</code> 收集器，使用 <code>s</code> 收集器不会引起 DataRow 的状态发生变化。对于此种对象类型的字段，应使用 <code>oc</code>收集器。即：</p> 
<div class="highlight highlight-text-html-basic">
 <pre>    &lt;<span class="pl-ent">input</span> <span class="pl-e">data</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>info,linkin<span class="pl-pds">&quot;</span></span> <span class="pl-e">renderer</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>std<span class="pl-pds">&quot;</span></span> <span class="pl-e">collector</span>=<span class="pl-s"><span class="pl-pds">&quot;</span>c|oc<span class="pl-pds">&quot;</span></span>&gt;</pre>
</div> 
<p>d2js 数据校验方面，使用如下表达：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-c1">d2js</span>.<span class="pl-en">create</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">rcd</span>){
    <span class="pl-en">$V</span>(rcd, {
        name <span class="pl-k">:</span> [<span class="pl-smi">V</span>.<span class="pl-smi">notNull</span>, <span class="pl-smi">V</span>.<span class="pl-en">shortest</span>(<span class="pl-c1">5</span>)],
        gender <span class="pl-k">:</span> [<span class="pl-smi">V</span>.<span class="pl-en">inside</span>([<span class="pl-s"><span class="pl-pds">'</span>M<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>F<span class="pl-pds">'</span></span>])],
        info <span class="pl-k">:</span> [<span class="pl-smi">V</span>.<span class="pl-en">attrs</span>([<span class="pl-s"><span class="pl-pds">'</span>linkin<span class="pl-pds">'</span></span>])],   <span class="pl-c">// 防止用户注入其它属性</span>
        <span class="pl-s"><span class="pl-pds">'</span>info,linkin<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-smi">V</span>.<span class="pl-en">shortest</span>(<span class="pl-c1">5</span>)]
    });

    <span class="pl-v">this</span>.<span class="pl-c1">insertRow</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, rcd, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>gender<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>info<span class="pl-pds">'</span></span>]);
}</pre>
</div> 
<p>在 d2js 中，jsonb 数据类型可以畅通无阻的 insert, update。</p> 
<h3> <a id="user-content-主从表" class="anchor" href="#%E4%B8%BB%E4%BB%8E%E8%A1%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>主从表</h3> 
<p>在d2js中，主从表在前端汇合，后端不需要做声明。</p> 
<p>前端声明两个表的关系的方法：</p> 
<div class="highlight highlight-source-js">
 <pre>    <span class="pl-k">var</span> author <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>author.d2js<span class="pl-pds">'</span></span>);
    <span class="pl-k">var</span> book <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">d2js.DataTable</span>(<span class="pl-s"><span class="pl-pds">'</span>book<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>book.d2js<span class="pl-pds">'</span></span>);

    <span class="pl-smi">author</span>.<span class="pl-en">addRelation</span>(<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>book<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>);</pre>
</div> 
<p>表之间的关系建立后，可以使用<code>findChildRows, findParentRows</code> 等函数访问子表行和父表行。</p> 
<p>在调用主表的 <code>submit</code> 提交数据时，子表数据也会连带提交。服务器所预备的若干个 d2js 的数据更新函数会陆续发生调用。虽然被调用的函数分散在不同的 d2js 文件中，整个提交过程仍在同一个事务中进行，一旦出错即整体回滚。</p> 
<p>尽管 d2js.dataset 支持表间关系，在实践中，d2js.DataTable 的数据来源通常<strong>应当为查询结果集</strong>，与数据库的表<strong>不能</strong>简单的一一对应，页面的d2js.dataset仅仅是RDBMS的一个<strong>剪影(snap)</strong>，千万要遏制把数据库结构照搬到网页上的冲动。</p> 
<h3> <a id="user-content-将d2js后端应用于其它前端框架" class="anchor" href="#%E5%B0%86d2js%E5%90%8E%E7%AB%AF%E5%BA%94%E7%94%A8%E4%BA%8E%E5%85%B6%E5%AE%83%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>将d2js后端应用于其它前端框架</h3> 
<p>d2js 前后端耦合程度很低，作为一种 RESTful 接口，d2js 服务可以轻松运用于其它前端框架。这里给出一个 ExtJS 的前端实现作为分享：</p> 
<div class="highlight highlight-source-js">
 <pre><span class="pl-smi">Ext</span>.<span class="pl-en">define</span>(<span class="pl-s"><span class="pl-pds">'</span>Ext.data.reader.D2jsJson<span class="pl-pds">'</span></span>, {
    extend<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Ext.data.reader.Json<span class="pl-pds">'</span></span>,
    alias <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>reader.d2js<span class="pl-pds">'</span></span>,
    successProperty <span class="pl-k">:</span> <span class="pl-c1">null</span>,
    messageProperty <span class="pl-k">:</span> <span class="pl-c1">null</span>,
    totalProperty <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>total<span class="pl-pds">'</span></span>,

    <span class="pl-en">getResponseData</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">response</span>) {
        <span class="pl-k">var</span> data, error;

        <span class="pl-k">try</span> {
            data <span class="pl-k">=</span> <span class="pl-smi">Ext</span>.<span class="pl-en">decode</span>(<span class="pl-smi">response</span>.<span class="pl-smi">responseText</span>);
            <span class="pl-k">if</span>(<span class="pl-smi">data</span>.<span class="pl-smi">error</span>) {
                error <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Ext.data</span>.<span class="pl-en">ResultSet</span>({
                    total  <span class="pl-k">:</span> <span class="pl-c1">0</span>, count  <span class="pl-k">:</span> <span class="pl-c1">0</span>, records<span class="pl-k">:</span> [], success<span class="pl-k">:</span> <span class="pl-c1">false</span>,
                    message<span class="pl-k">:</span> <span class="pl-smi">data</span>.<span class="pl-smi">error</span>
                });
            }
        } <span class="pl-k">catch</span>(ex){
            error <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Ext.data</span>.<span class="pl-en">ResultSet</span>({
                total  <span class="pl-k">:</span> <span class="pl-c1">0</span>, count  <span class="pl-k">:</span> <span class="pl-c1">0</span>, records<span class="pl-k">:</span> [], success<span class="pl-k">:</span> <span class="pl-c1">false</span>,
                message<span class="pl-k">:</span> <span class="pl-smi">response</span>.<span class="pl-smi">responseText</span>
            });
        }        
        <span class="pl-k">if</span>(<span class="pl-k">!</span>error){
            <span class="pl-k">try</span>{                
                <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">readRecords</span>(data);
            } <span class="pl-k">catch</span> (ex) {
                error <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Ext.data</span>.<span class="pl-en">ResultSet</span>({
                    total  <span class="pl-k">:</span> <span class="pl-c1">0</span>, count  <span class="pl-k">:</span> <span class="pl-c1">0</span>, records<span class="pl-k">:</span> [], success<span class="pl-k">:</span> <span class="pl-c1">false</span>,
                    message<span class="pl-k">:</span> <span class="pl-smi">ex</span>.<span class="pl-smi">message</span>
                });             
            }
        }
        <span class="pl-v">this</span>.<span class="pl-en">fireEvent</span>(<span class="pl-s"><span class="pl-pds">'</span>exception<span class="pl-pds">'</span></span>, <span class="pl-v">this</span>, response, error);

        <span class="pl-smi">Ext</span>.<span class="pl-smi">Logger</span>.<span class="pl-en">warn</span>(<span class="pl-s"><span class="pl-pds">'</span>Unable to parse the JSON returned by the server<span class="pl-pds">'</span></span>);

        <span class="pl-k">return</span> error;
    },

    <span class="pl-en">getMeta</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">data</span>){
        <span class="pl-k">return</span> {root <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rows<span class="pl-pds">'</span></span>, fields <span class="pl-k">:</span> <span class="pl-smi">data</span>.<span class="pl-smi">columns</span>};
    },

    <span class="pl-en">readRecords</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
        <span class="pl-k">if</span>(<span class="pl-smi">data</span>.<span class="pl-smi">error</span>){
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-smi">data</span>.<span class="pl-smi">error</span>);
        } <span class="pl-k">else</span> {
            <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-en">callParent</span>(arguments);
        }
    },
    <span class="pl-en">buildExtractors</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(){
        <span class="pl-v">this</span>.<span class="pl-en">callParent</span>(arguments);
        <span class="pl-v">this</span>.<span class="pl-smi">getRoot</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">data</span>){
            <span class="pl-k">if</span>(<span class="pl-smi">data</span>.<span class="pl-c1">data</span>) <span class="pl-k">return</span> <span class="pl-smi">data</span>.<span class="pl-c1">data</span>.<span class="pl-c1">rows</span>;
            <span class="pl-k">if</span>(<span class="pl-smi">data</span>.<span class="pl-c1">rows</span>) <span class="pl-k">return</span> <span class="pl-smi">data</span>.<span class="pl-c1">rows</span>;
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
        <span class="pl-v">this</span>.<span class="pl-smi">getMeta</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">data</span>){
            <span class="pl-k">if</span>(<span class="pl-smi">data</span>.<span class="pl-c1">data</span>) <span class="pl-k">return</span> <span class="pl-smi">data</span>.<span class="pl-c1">data</span>.<span class="pl-smi">columns</span>;
            <span class="pl-k">if</span>(<span class="pl-smi">data</span>.<span class="pl-smi">columns</span>) <span class="pl-k">return</span> <span class="pl-smi">data</span>.<span class="pl-smi">columns</span>;
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    }

});

<span class="pl-smi">Ext</span>.<span class="pl-en">define</span>(<span class="pl-s"><span class="pl-pds">'</span>Ext.data.writer.D2jsJson<span class="pl-pds">'</span></span>, {
    extend<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Ext.data.writer.Json<span class="pl-pds">'</span></span>,
    alias <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>writer.d2js<span class="pl-pds">'</span></span>,
    <span class="pl-en">writeRecords</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">request</span>, <span class="pl-smi">data</span>) {
        <span class="pl-k">var</span> root <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">root</span>;

        <span class="pl-k">if</span> (<span class="pl-v">this</span>.<span class="pl-smi">expandData</span>) {
            data <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-en">getExpandedData</span>(data);
        }

        <span class="pl-k">if</span> (<span class="pl-v">this</span>.<span class="pl-smi">allowSingle</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">data</span>.<span class="pl-c1">length</span> <span class="pl-k">===</span> <span class="pl-c1">1</span>) {
            data <span class="pl-k">=</span> data[<span class="pl-c1">0</span>];
        }

        <span class="pl-k">var</span> params <span class="pl-k">=</span> <span class="pl-smi">request</span>.<span class="pl-smi">params</span>.<span class="pl-smi">params</span>;
        <span class="pl-k">if</span>(params) params <span class="pl-k">=</span> <span class="pl-c1">JSON</span>.<span class="pl-c1">parse</span>(params);

        <span class="pl-smi">Ext</span>.<span class="pl-c1">apply</span>(params, data);

        <span class="pl-smi">request</span>.<span class="pl-smi">params</span>.<span class="pl-smi">params</span> <span class="pl-k">=</span> <span class="pl-c1">JSON</span>.<span class="pl-en">stringify</span>(params);

        <span class="pl-k">return</span> request;
    }, 
    <span class="pl-en">getRecordData</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">record</span>, <span class="pl-smi">operation</span>) {
        <span class="pl-k">var</span> r <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-en">callParent</span>(arguments);
        <span class="pl-k">if</span>(<span class="pl-smi">operation</span>.<span class="pl-c1">action</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>update<span class="pl-pds">'</span></span>){
            <span class="pl-smi">r</span>.<span class="pl-smi">_origin</span> <span class="pl-k">=</span> <span class="pl-smi">record</span>.<span class="pl-smi">raw</span>;
        }
        <span class="pl-k">return</span> r;
    }
});

<span class="pl-smi">Ext</span>.<span class="pl-en">define</span>(<span class="pl-s"><span class="pl-pds">'</span>Ext.data.proxy.D2js<span class="pl-pds">'</span></span>, {
    extend<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Ext.data.proxy.Rest<span class="pl-pds">'</span></span>,
    alternateClassName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Ext.data.RestProxy<span class="pl-pds">'</span></span>,
    alias <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>proxy.d2js<span class="pl-pds">'</span></span>,
    actionMethods<span class="pl-k">:</span> {
        create <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>,
        read   <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>GET<span class="pl-pds">'</span></span>,
        update <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>,
        destroy<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>
    },
    d2jsMethods<span class="pl-k">:</span> {
        create <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>create<span class="pl-pds">'</span></span>,
        read   <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>,
        update <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>modify<span class="pl-pds">'</span></span>,
        destroy<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>destroy<span class="pl-pds">'</span></span>
    },
    reader <span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>d2js<span class="pl-pds">'</span></span>
    }, writer <span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>d2js<span class="pl-pds">'</span></span>
    },
    appendId <span class="pl-k">:</span> <span class="pl-c1">false</span>,

    <span class="pl-en">getParams</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">operation</span>) {
        <span class="pl-k">var</span> me <span class="pl-k">=</span> <span class="pl-v">this</span>,
            params <span class="pl-k">=</span> {},
            sorters <span class="pl-k">=</span> <span class="pl-smi">operation</span>.<span class="pl-smi">sorters</span>;

        params <span class="pl-k">=</span> <span class="pl-smi">operation</span>.<span class="pl-smi">params</span>.<span class="pl-smi">q</span> <span class="pl-k">||</span> {};        

        <span class="pl-k">if</span>(<span class="pl-smi">operation</span>.<span class="pl-c1">start</span> <span class="pl-k">!=</span> <span class="pl-c1">null</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">operation</span>.<span class="pl-smi">limit</span> <span class="pl-k">!=</span> <span class="pl-c1">null</span>){
            <span class="pl-smi">params</span>.<span class="pl-smi">_page</span> <span class="pl-k">=</span> {start <span class="pl-k">:</span> <span class="pl-smi">operation</span>.<span class="pl-c1">start</span> <span class="pl-k">||</span> <span class="pl-c1">0</span>, limit <span class="pl-k">:</span> <span class="pl-smi">operation</span>.<span class="pl-smi">limit</span> <span class="pl-k">||</span> <span class="pl-c1">0</span>};        
        }

        <span class="pl-k">if</span>(sorters){
            <span class="pl-k">var</span> sorts <span class="pl-k">=</span> {};
            <span class="pl-k">for</span>(<span class="pl-k">var</span> i<span class="pl-k">=</span><span class="pl-c1">0</span>; i<span class="pl-k">&lt;</span><span class="pl-smi">sorters</span>.<span class="pl-c1">length</span>; i<span class="pl-k">++</span>){
                sorts[sorters[i].<span class="pl-smi">property</span>] <span class="pl-k">=</span> sorters[i].<span class="pl-smi">direction</span>; 
            }
            <span class="pl-smi">params</span>.<span class="pl-smi">_sorts</span> <span class="pl-k">=</span> sorts;
        }

        <span class="pl-k">delete</span> <span class="pl-smi">operation</span>.<span class="pl-smi">params</span>.<span class="pl-smi">q</span>;

        params <span class="pl-k">=</span> { params <span class="pl-k">:</span> <span class="pl-c1">JSON</span>.<span class="pl-en">stringify</span>(params)};
        <span class="pl-k">if</span>(<span class="pl-smi">operation</span>.<span class="pl-smi">params</span>.<span class="pl-smi">_m</span>){
            <span class="pl-smi">params</span>.<span class="pl-smi">_m</span> <span class="pl-k">=</span> <span class="pl-smi">operation</span>.<span class="pl-smi">params</span>.<span class="pl-smi">_m</span>; 
        } <span class="pl-k">else</span> {
            <span class="pl-smi">params</span>.<span class="pl-smi">_m</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">d2jsMethods</span>[<span class="pl-smi">operation</span>.<span class="pl-c1">action</span>];
        }
        <span class="pl-k">return</span> params;
    }
});

<span class="pl-smi">Ext</span>.<span class="pl-en">define</span>(<span class="pl-s"><span class="pl-pds">'</span>Org.Siphon.D2js.Store<span class="pl-pds">'</span></span>, {
    extend <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Ext.data.Store<span class="pl-pds">'</span></span>, autoLoad <span class="pl-k">:</span> <span class="pl-c1">false</span>,
    pageSize <span class="pl-k">:</span> <span class="pl-c1">10</span>, remoteSort <span class="pl-k">:</span> <span class="pl-c1">true</span>, proxy <span class="pl-k">:</span> { type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>db2js<span class="pl-pds">'</span></span> }, listeners <span class="pl-k">:</span> {
        update <span class="pl-k">:</span> <span class="pl-smi">Ext</span>.<span class="pl-smi">emptyFn</span>
    }, <span class="pl-en">load</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">options</span>) {
        <span class="pl-k">var</span> bparams <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>;
        <span class="pl-k">if</span> (options <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">options</span>.<span class="pl-smi">params</span> <span class="pl-k">&amp;&amp;</span> bparams <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">bparams</span>.<span class="pl-smi">params</span>) {
            <span class="pl-smi">Ext</span>.<span class="pl-en">applyIf</span>(<span class="pl-smi">options</span>.<span class="pl-smi">params</span>, <span class="pl-smi">bparams</span>.<span class="pl-smi">params</span>);
        }
        options <span class="pl-k">=</span> <span class="pl-smi">Ext</span>.<span class="pl-en">applyIf</span>(options <span class="pl-k">||</span> {}, bparams);
        <span class="pl-v">this</span>.<span class="pl-en">callParent</span>([ options ]);
    }, <span class="pl-en">constructor</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">config</span>) {
        <span class="pl-v">this</span>.<span class="pl-smi">proxy</span>.<span class="pl-smi">model</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">model</span>;
        <span class="pl-v">this</span>.<span class="pl-en">callParent</span>([ config ]);
        <span class="pl-v">this</span>.<span class="pl-smi">proxy</span>.<span class="pl-smi">url</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">proxy</span>.<span class="pl-smi">url</span> <span class="pl-k">||</span> (<span class="pl-v">this</span>.<span class="pl-smi">model</span> <span class="pl-k">?</span> (<span class="pl-k">new</span> <span class="pl-en">this.model</span>()).<span class="pl-smi">url</span> <span class="pl-k">:</span> <span class="pl-c1">null</span>) <span class="pl-k">||</span> <span class="pl-smi">config</span>.<span class="pl-smi">url</span>;
        <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span> <span class="pl-k">=</span> <span class="pl-smi">config</span>.<span class="pl-smi">baseParams</span>;
    }, <span class="pl-en">q</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">query</span>) {    <span class="pl-c">/* {cond : value, cond : value} */</span>
        <span class="pl-k">var</span> qd <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span>.<span class="pl-smi">q</span>;
        <span class="pl-k">if</span> (qd) {
            qd <span class="pl-k">=</span> <span class="pl-smi">Ext</span>.<span class="pl-c1">apply</span>(qd, query);
        } <span class="pl-k">else</span> {
            qd <span class="pl-k">=</span> query;
        }
        <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>)
            <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span> <span class="pl-k">=</span> {};
        <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span>)
            <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span> <span class="pl-k">=</span> {};
        <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span>.<span class="pl-smi">q</span> <span class="pl-k">=</span> qd;
        <span class="pl-k">return</span> <span class="pl-v">this</span>;
    }, <span class="pl-en">m</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">method</span>) {
        <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>)
            <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span> <span class="pl-k">=</span> {};
        <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span>)
            <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span> <span class="pl-k">=</span> {};
        <span class="pl-v">this</span>.<span class="pl-smi">baseParams</span>.<span class="pl-smi">params</span>.<span class="pl-smi">_m</span> <span class="pl-k">=</span> method;
        <span class="pl-k">return</span> <span class="pl-v">this</span>;
    }
});

<span class="pl-c">/**</span>
<span class="pl-c"> * 使用方法  :</span>
<span class="pl-c"> * var store = Ext.create('Org.Siphon.DynaStore', {url : 'author.d2js'});</span>
<span class="pl-c"> * store.m('fetch').load({params : {name : 'Kant'}}); </span>
<span class="pl-c"> */</span>
<span class="pl-smi">Ext</span>.<span class="pl-en">define</span>(<span class="pl-s"><span class="pl-pds">'</span>Org.Siphon.DynaStore<span class="pl-pds">'</span></span>, {
    extend <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Org.Siphon.Store<span class="pl-pds">'</span></span>, autoLoad <span class="pl-k">:</span> <span class="pl-c1">false</span>, proxy <span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>db2js<span class="pl-pds">'</span></span>, reader <span class="pl-k">:</span> {type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>db2js<span class="pl-pds">'</span></span>, useRemoteMeta <span class="pl-k">:</span> <span class="pl-c1">true</span>} 
    },
    <span class="pl-en">setProxy</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">proxy</span>) {     <span class="pl-c">// ext 忘了设置 proxy.store,但是在proxy.setModel(model, true)需要用到</span>
        <span class="pl-k">var</span> p <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-en">callParent</span>([proxy]);
        <span class="pl-smi">p</span>.<span class="pl-smi">store</span> <span class="pl-k">=</span> <span class="pl-v">this</span>;
        <span class="pl-k">return</span> p;
    },
    <span class="pl-en">setModel</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">model</span>){      <span class="pl-c">// ext 没有这个函数,但是 proxy.setModel(model, true) 调用到了它</span>
        <span class="pl-v">this</span>.<span class="pl-smi">model</span> <span class="pl-k">=</span> model;
    }
});
</pre>
</div> 
<p>其它客户端形式也可以根据自身情况开发接口连接 d2js 服务或开发类似 d2js 的前端框架。</p> 
<ul> 
 <li>.net 可以利用现有 ADO.net 的 DataSet 框架，编写 TableAdapter 实现调用服务器 .d2js 的功能，但由于控件无法插拔，较难实现 render 和 collect 体系；</li> 
 <li>java 包括服务器端、Android 端，可以编写类似的 DataSet 框架，同样由于面向对象的控件无法插拔，较难实现 render 与 collect；</li> 
 <li>ios 等其它平台与 java 同理。</li> 
</ul>
</body>
</html>
